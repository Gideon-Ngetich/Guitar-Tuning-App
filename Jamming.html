<!DOCTYPE html>
<html>

<head>
    <title>Videos Page</title>
    <!-- Include Firebase JavaScript SDK and initialize Firebase -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <style>
        .video-item {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .video-item:focus {
            @apply fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-3/4 h-auto z-50 filter blur-lg;
        }

        .blur {
            @apply filter blur-lg;
        }
    </style>

</head>

<body>
    <nav class="relative px-4 py-4 flex justify-between items-center bg-white">
        <a class="text-6xl lg:text-3xl font-bold leading-none" href="index.html">
            AjayTuner
        </a>
        <div class="flex">
            <button class="navbar-burger flex items-center text-blue-600 p-3 lg:hidden w-20 h-20">
                <svg class="block h-10 w-10 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <title>Mobile menu</title>
                    <path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path>
                </svg>
            </button>
            <div class="hidden lg:inline-block">
                <a href="Userprofile.html" id="navimgelementLink" class="lg:inline-block md:hidden">
                    <div id="navuserImgDiv" class="user-img w-14 h-14 rounded-full lg:inline-block md:hidden">
                        <img id="Navuserimg" class="Navuserimg hidden rounded-full w-14 h-14 " src="" alt="">
                    </div>
                </a>
            </div>

        </div>
        <ul
            class="hidden absolute top-1/2 left-1/2 transform -translate-y-1/2 -translate-x-1/2 lg:flex lg:mx-auto lg:items-center lg:w-auto lg:space-x-6">
            <li><a class="text-sm text-black font-bold hover:text-gray-500" href="/">Home</a></li>
            <li class="text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" class="w-4 h-4 current-fill"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 5v0m0 7v0m0 7v0m0-13a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            </li>
            <li><a class="text-sm text-black font-bold" href="Aboutus.html">About Us</a></li>
            <li class="text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" class="w-4 h-4 current-fill"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 5v0m0 7v0m0 7v0m0-13a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            </li>
            <li><a class="text-sm text-black font-bold hover:text-gray-500" href="Tunner.html">Tuner</a></li>
            <li class="text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" class="w-4 h-4 current-fill"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 5v0m0 7v0m0 7v0m0-13a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            </li>
            <li><a class="text-sm text-black font-bold hover:text-gray-500" href="Blog.html">Blog</a></li>
            <li class="text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" class="w-4 h-4 current-fill"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 5v0m0 7v0m0 7v0m0-13a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            </li>
            <li><a class="text-sm text-blue-500 font-bold hover:text-gray-500" href="Jamming.html">Jamming</a></li>
        </ul>
        <a class="hidden lg:inline-block lg:ml-auto lg:mr-3 py-2 px-6 bg-gray-50 hover:bg-gray-100 text-sm text-gray-900 font-bold  rounded-xl transition duration-200"
            id="signin-res" href="login.html">Sign In</a>
        <a class="hidden lg:inline-block py-2 px-6 bg-blue-500 hover:bg-blue-600 text-sm text-white font-bold rounded-xl transition duration-200"
            id="signup-res" href="signup.html">Sign up</a>

    </nav>
    <div class="navbar-menu relative z-50 hidden">
        <div class="navbar-backdrop fixed inset-0 bg-gray-800 opacity-25"></div>
        <nav class="fixed top-0 left-0 bottom-0 flex flex-col w-9/12 py-6 px-6 bg-white border-r overflow-y-auto">
            <div class="flex items-center mb-8">
                <a class="mr-auto text-6xl font-bold leading-none max-w-sm" href="index.html">
                    AjayTuner
                </a>
                <button class="navbar-close">
                    <svg class="h-12 w-12 text-gray-400 cursor-pointer hover:text-gray-500"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div>

                <a href="Userprofile.html" id="navimgelementResLink" class=" lg:flex">
                    <div id="navprofileImgDiv" class="user-img w-40 h-40 rounded-full my-20 ">
                        <img id="NavuserimgRes" class="Navuserimg rounded-full w-40 h-40 mx-20" src="" alt="">
                    </div>
                </a>
                <ul>
                    <li class="m-20">
                        <a class="block p-4 text-4xl font-semibold text-black hover:bg-blue-50 hover:text-blue-600 rounded"
                            href="index.html">Home</a>
                    </li>
                    <li class="m-20">
                        <a class="block p-4 text-4xl font-semibold text-black hover:bg-blue-50 hover:text-blue-600 rounded"
                            href="Aboutus.html">About Us</a>
                    </li>
                    <li class="m-20">
                        <a class="block p-4 text-4xl font-semibold text-black hover:bg-blue-50 hover:text-blue-600 rounded"
                            href="Tunner.html">Tuner</a>
                    </li>
                    <li class="m-20">
                        <a class="block p-4 text-4xl font-semibold text-black hover:bg-blue-50 hover:text-blue-600 rounded"
                            href="Blog.html">Blog</a>
                    </li>
                    <li class="m-20">
                        <a class="block p-4 text-4xl font-semibold text-blue-500 hover:bg-blue-50 hover:text-blue-600 rounded"
                            href="Jamming.html">Jamming</a>
                    </li>
                </ul>
            </div>
            <div class="mt-auto">
                <div class="pt-6">
                    <a class="block px-4 py-3 mb-3 leading-loose text-xs text-center font-semibold bg-gray-50 hover:bg-gray-100 rounded-xl"
                        id="signin" href="login.html">Sign in</a>
                    <a class="block px-4 py-3 mb-2 leading-loose text-xs text-center text-white font-semibold bg-blue-600 hover:bg-blue-700  rounded-xl"
                        id="signup" href="signup.html">Sign Up</a>
                </div>
                <p class="my-4 text-xs text-center text-gray-400">
                    <span>Copyright © 2023</span>
                </p>
            </div>
        </nav>
    </div>
    <div class="flex justify-center items-center bg-blue-900 h-10 w-full md:h-36">
        <h1 class="text-6xl lg:text-xl w-full flex justify-center items-center font-bold text-white">Jamming Sessions
        </h1>
    </div>

    <div id="loading-page">
        <div class="spinner"></div>
    </div>

    <!-- Container for the videos -->
    <div id="video-container" class="flex-col w-full m-2 lg:m-2 gap-2 items-center flex-wrap justify-center ">
        <div id="userproileimg" class="userproileimg"></div>
    </div>

    <script src="app.js"></script>
    <script type="module">
        // Initialize Firebase with your configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
        import { onValue, getDatabase, set, ref as databaseRef } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js"
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";


        const firebaseConfig = {
            apiKey: "AIzaSyADlFpFRYXFTTnYtdPWaS5FpylahOkyTek",
            authDomain: "guitar-tunner-9bd54.firebaseapp.com",
            projectId: "guitar-tunner-9bd54",
            storageBucket: "guitar-tunner-9bd54.appspot.com",
            messagingSenderId: "534214805325",
            appId: "1:534214805325:web:8941f0e10a240d5d085904",
            measurementId: "G-4F13BLVGNM"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const auth = getAuth(app)
        const db = getDatabase(app)

        //

        function fetchAndDisplayVideos() {
            const videosContainer = document.getElementById('video-container');
            const profilediv = document.getElementById('userproileimg')
            const videoWrapper = document.getElementById('videodiv');
            const loadingPage = document.getElementById('loading-page');
            videosContainer.innerHTML = '';

            loadingPage.style.display = 'block';

            const usersRef = databaseRef(db, 'Users');

            onValue(usersRef, (snapshot) => {
                const users = snapshot.val();

                for (const userId in users) {
                    const userData = users[userId].userData;
                    const videos = users[userId].videos;
                    const profileImg = users[userId].ProfileImg;


                    if (userData) {
                        const userName = userData.firstName + ' ' + userData.lastName;

                        for (const videoId in videos) {
                            const videoMetadata = videos[videoId].videoMetadata;

                            // Create a div for the video and uploader information
                            const videoWrapper = document.createElement('div');
                            videoWrapper.classList.add('flex', 'flex-col', 'w-3/4', 'lg:w-1/2', 'h-auto', 'lg:h-screen', 'p-1', 'bg-grey-400', 'shadow-lg', 'rounded-lg', 'relative');

                            // Create a video element for each video
                            const videoElement = document.createElement('video');
                            videoElement.classList.add('video-item', 'h-96', 'cover', 'w-full', 'aspect-video', 'flex', 'items-center', 'justify-bottom', 'bg-gray-2');
                            videoElement.src = videoMetadata.url;
                            videoElement.controls = false; // Disable default video controls

                            // Create a play button wrapper
                            const playButtonWrapper = document.createElement('div');
                            playButtonWrapper.classList.add('play-button-wrapper', 'absolute', '-top-20', 'inset-52', 'flex', 'items-center', 'justify-center', 'bg-gray-2', 'w-30', 'h-30', '-z-30');

                            // Create a play button for video controls
                            const playButton = document.createElement('button');
                            playButton.classList.add('play-button', 'flex', 'text-white', 'text-4xl', 'focus:outline-none',);
                            playButton.textContent = '▶';

                            const pauseButton = document.createElement('button');
                            pauseButton.classList.add('pause-button', 'flex', 'text-white', 'text-4xl', 'focus:outline-none', 'z-40');
                            pauseButton.textContent = '❚❚';
                            pauseButton.style.display = 'none'; // Hide the pause button initially



                            // playButton.addEventListener('click', function () {
                            //     if (videoElement.paused) {
                            //         videoElement.play();
                            //         playButton.style.display = 'none'; // Hide the play button when the video is playing
                            //         pauseButton.style.display = 'block'; // Show the pause button when the video is playing

                            //         setTimeout(function () {
                            //             pauseButton.style.display = 'none'; // Hide the pause button after a few seconds
                            //         }, 3000); // Adjust the duration in milliseconds (e.g., 3000ms = 3 seconds)
                            //     } else {
                            //         videoElement.pause();
                            //         playButton.style.display = 'block'
                            //     }


                            // });

                            // playButton.addEventListener('click', function () {
                            //     const videos = document.querySelectorAll('video');
                            //     const currentVideo = videoElement;

                            //     if (currentVideo.paused) {
                            //         videos.forEach(function (video) {
                            //             if (video !== currentVideo) {
                            //                 video.pause();
                            //             }
                            //         });

                            //         currentVideo.play();
                            //         playButton.style.display = 'none';
                            //         pauseButton.style.display = 'block';

                            //         setTimeout(function () {
                            //             pauseButton.style.display = 'none';
                            //         }, 3000);
                            //     } else {
                            //         currentVideo.pause();
                            //         playButton.style.display = 'block';
                            //     }
                            // });



                            // videoElement.addEventListener('click', function () {
                            //     if (videoElement.paused) {
                            //         videoElement.play();  // Start playing the video
                            //         playButton.style.display = 'none';  // Hide the play button
                            //         pauseButton.style.display = 'block'; // Show the pause button
                            //     } else {
                            //         videoElement.pause();  // Pause the video
                            //         pauseButton.style.display = 'none'; // Hide the pause button
                            //         playButton.style.display = 'block'; // Show the play button
                            //     }
                            // });

                            playButton.addEventListener('click', function () {
                                const videos = document.querySelectorAll('video');
                                const currentVideo = videoElement;

                                if (currentVideo.paused) {
                                    videos.forEach(function (video) {
                                        if (video !== currentVideo) {
                                            video.pause();
                                        }
                                    });

                                    currentVideo.play();
                                    playButton.style.display = 'none';
                                    pauseButton.style.display = 'block';

                                    setTimeout(function () {
                                        pauseButton.style.display = 'none';
                                    }, 3000);
                                } else {
                                    currentVideo.pause();
                                    pauseButton.style.display = 'none'
                                    playButton.style.display = 'block';
                                }
                            });

                            videoElement.addEventListener('click', function () {
                                const videos = document.querySelectorAll('video')
                                const currentVideo = videoElement

                                if (currentVideo.paused){
                                    videos.forEach(function(video){
                                        if(video !== currentVideo){
                                            video.pause()
                                        }
                                    })
                                    currentVideo.play();
                                    playButton.style.display = 'none'
                                    pauseButton.style.display = 'block'
                                }else if(!currentVideo){
                                    pauseButton.style.display = 'none'
                                    playButton.style.display = 'block'
                                }else{
                                    currentVideo.pause()
                                    pauseButton.style.display = 'none'
                                    playButton.style.display = 'block'
                                }
                                
                            });

                            pauseButton.addEventListener('click', function () {
                                if (!videoElement.paused) {
                                    videoElement.pause();
                                    pauseButton.style.display = 'none'; // Hide the pause button when the video is paused
                                    playButton.style.display = 'block'; // Show the play button when the video is paused
                                }
                            });

                            videoElement.addEventListener('ended', function () {
                                playButton.style.display = 'block'
                            })

                            // Add event listeners to show/hide pause button on hover
                            videoWrapper.addEventListener('mouseenter', function () {
                                if (!videoElement.paused) {
                                    pauseButton.style.display = 'block';
                                }
                            });

                            videoWrapper.addEventListener('mouseleave', function () {
                                if (!videoElement.paused) {
                                    pauseButton.style.display = 'none';
                                }
                            });



                            // Append the play button to the play button wrapper
                            playButtonWrapper.appendChild(playButton);
                            playButtonWrapper.appendChild(pauseButton);

                            // Append the video element and play button wrapper to the wrapper
                            videoWrapper.appendChild(videoElement);
                            videoWrapper.appendChild(playButtonWrapper);

                            // Create seek bar container
                            const seekBarContainer = document.createElement('div');
                            seekBarContainer.classList.add('bg-gray-300', 'relative', 'cursor-pointer', 'm-2', '-top-14');
                            seekBarContainer.id = 'seekbarContainer';

                            // function setUpVideoPlayer(){
                            //     const videos = videoElement;
                            //     let activeVideo = null;

                            //     videos.forEach(function(video){
                            //         video.addEventListener('play', function(){
                            //             if(activeVideo && activeVideo !== vide0){
                            //                 activeVideo.pause()
                            //             }
                            //             activeVideo = video
                            //         })
                            //     })

                            // }

                            // Create seek bar progress element
                            const Progressed = document.createElement('div');
                            Progressed.classList.add('h-full', 'bg-red-500');
                            Progressed.id = 'progressed';

                            videoElement.ontimeupdate = function () {
                                Progressed.style.width = Math.floor(videoElement.currentTime * 100 / videoElement.duration) + "%";
                            }
                            seekBarContainer.onclick = function (e) {
                                videoElement.currentTime = (e.offsetX / seekBarContainer.offsetWidth) * videoElement.duration;
                            }

                            // Append progress and thumb to the seek bar container
                            seekBarContainer.appendChild(Progressed);

                            // Append seek bar container to the document body or any desired parent element
                            document.body.appendChild(seekBarContainer);

                            videoWrapper.appendChild(seekBarContainer);

                            const userInfo = document.createElement('div');
                            userInfo.classList.add('flex', 'gap-2', 'mt-2');

                            // Create a paragraph element for the uploader's name
                            const uploaderElement = document.createElement('p');
                            uploaderElement.classList.add('text-start', 'text-3xl', 'lg:text-sm', 'font-italics', 'text-grey-700', 'p-4');
                            uploaderElement.textContent = "Artist: " + userName;

                            const videoDescription = document.createElement('p');
                            videoDescription.classList.add('text-start', 'text-3xl', 'lg:text-sm', 'font-italics', 'text-grey-700', 'bg-gray-200', 'p-2', 'lg:p-1', 'h-30', 'overflow-elipsis', 'md:overflow-hidden');
                            videoDescription.textContent = videoMetadata.description;

                            const userImgElement = document.createElement('img');
                            userImgElement.classList.add('rounded-full', 'h-20', 'w-20', 'lg:h-14', 'lg:w-14', 'object-cover', 'object-center', 'flex-shrink-0',);

                            // Check if profile image exists and set the source
                            if (profileImg && profileImg.profileImgUrl) {
                                userImgElement.src = profileImg.profileImgUrl;
                            } else {
                                // Set a fallback image source if profile image is not available
                                userImgElement.src = 'fallback-profile-image.jpg';
                            }

                            // Create a "Read More" button for the video description
                            const readMoreButton = document.createElement('button');
                            readMoreButton.classList.add('read-more-button', 'text-blue-500', 'underline', 'mt-2', 'focus:outline-none');
                            readMoreButton.textContent = 'Read More';

                            // Add event listener to the "Read More" button
                            readMoreButton.addEventListener('click', function () {
                                videoDescription.classList.toggle('h-auto'); // Toggle between auto height and fixed height
                                if (videoDescription.classList.contains('overflow-hidden')) {

                                    readMoreButton.textContent = 'Read Less';
                                } else {
                                    readMoreButton.textContent = 'Read More';
                                }
                            });

                            // Append uploader element, video description, and "Read More" button to the user info div
                            userInfo.appendChild(uploaderElement);
                            userInfo.appendChild(videoDescription);
                            userInfo.appendChild(readMoreButton);

                            // Append the video wrapper and user info to the document body
                            document.body.appendChild(videoWrapper);
                            document.body.appendChild(userInfo);


                            // Append the elements to the wrapper
                            userInfo.appendChild(userImgElement);
                            userInfo.appendChild(uploaderElement);
                            videoWrapper.appendChild(videoDescription);
                            videoWrapper.appendChild(readMoreButton);
                            videoWrapper.appendChild(userInfo);

                            // Append the video wrapper to the container
                            videosContainer.appendChild(videoWrapper);
                        }
                    }
                    loadingPage.style.display = 'none';
                    videosContainer.style.display = 'flex';


                }

            }
            )
        }


        const videoItems = document.querySelectorAll('.video-item');

        function displayUserImg() {
            const user = auth.currentUser

            if (user) {
                const userId = user.uid

                const profileRef = databaseRef(db, `Users/${userId}/ProfileImg`);
                const NavuserImgElement = document.getElementById('Navuserimg');
                const NavuserImgResElement = document.getElementById('NavuserimgRes')
                onValue(profileRef, (snapshot) => {
                    const profileImg = snapshot.val();
                    if (profileImg && profileImg.profileImgUrl) {
                        NavuserImgElement.src = profileImg.profileImgUrl
                        NavuserImgResElement.src = profileImg.profileImgUrl
                    } else {
                        NavuserImgElement.src = 'https://firebasestorage.googleapis.com/v0/b/guitar-tunner-9bd54.appspot.com/o/Fallbackimage%2FUserAccountImg.jpg?alt=media&token=196736bc-792c-4f98-bef2-5ce5f2efa047'
                        NavuserImgResElement.src = 'https://firebasestorage.googleapis.com/v0/b/guitar-tunner-9bd54.appspot.com/o/Fallbackimage%2FUserAccountImg.jpg?alt=media&token=196736bc-792c-4f98-bef2-5ce5f2efa047'
                    }
                })
            }
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                // Call fetchAndDisplayVideos when the user is logged in
                displayUserImg()
            } else {
                console.log('User not logged in');
            }
        });

        fetchAndDisplayVideos();

        let timeOut;
        function resetTimeout() {
            clearTimeout(timeOut);
            timeOut = setTimeout(logout, 600000)
        }

        const userAuthtenticated = sessionStorage.getItem('userAuthenticated');
        if (userAuthtenticated === 'true') {
            const signup = document.getElementById('signup');
            const signin = document.getElementById('signin')
            const signupRes = document.getElementById('signup-res');
            const signinRes = document.getElementById('signin-res')
            const Navuserimg = document.getElementById('Navuserimg');
            const NavuserimgRes = document.getElementById('NavuserimgRes');

            signupRes.style.display = 'none'
            signinRes.style.display = 'none'
            signin.style.display = 'none'
            signup.style.display = 'none'
            Navuserimg.style.display = 'flex'
            NavuserimgRes.style.display = 'flex'
        }

        function logout() {
            auth.signOut().then(() => {
                sessionStorage.removeItem('userAuthenticated')
                window.location.href = 'login.html'
            })
                .catch((error) => {
                    console.log('Error logging out', error);
                })
        }

        document.addEventListener('mousemove', resetTimeout);
        document.addEventListener('keypress', resetTimeout);
        document.addEventListener('mousedown', resetTimeout);

        resetTimeout();
    </script>

</body>

</html>